---
title: "77-asca-exon"
author: "Ariana Huffmyer"
date: "2024-03-06"
output: html_document
editor_options: 
  chunk_output_type: console
---

Run an ASCA analysis on exon expression data.  

# Load libraries 

```{r}
library(tidyverse)
```

# Females NEED TO COPY FOR MALES 

## Load data 

```{r}
females <- fread("output/72-exon-data-rfmt/female_exon_tf.csv")
```

## Format data 

Format data by adding a sample and fold change column.  

```{r}
females <- females %>%
  mutate(fold = sapply(strsplit(as.character(SampleID_fold), "_"), function(x) x[2]))%>%
  mutate(sample = sapply(strsplit(as.character(SampleID_fold), "_"), function(x) x[1]))%>%
  select(!SampleID_fold)%>%
  select(sample, fold, everything())

head(females)
```

Read in metadata and add information for treatment.  

```{r}
meta<-read_csv("data/adult-meta.csv")

females$treatment<-meta$Treatment[match(females$sample, meta$OldSample.ID)]

females <- females %>%
  mutate(sex=c("Female"))%>%
  select(sample, fold, treatment, sex, everything())
```

We now have a column for sample, fold, treatment, sex, and a column for each gene. Here are the levels of each factor.   

```{r}
levels(as.factor(females$sample))
levels(as.factor(females$fold))
levels(as.factor(females$treatment))
levels(as.factor(females$sex))
```

Remove genes that have NA values. 

```{r}
females<-females %>%
    select_if(~ !any(is.na(.)))
```

We had 13284 columns (13280 genes) and now have 11270 after NA removal. 

Finally, format with gene in a column and value in its own column. 
```{r}
long_females<-females%>%
  pivot_longer(cols=5:11274, names_to="gene", values_to="value")

str(long_females)
```

## ALASCA   

https://pubmed.ncbi.nlm.nih.gov/36387276/ 
https://github.com/andjar/ALASCA

```{r}
#if (!requireNamespace("devtools", quietly = TRUE))
#    install.packages("devtools")

#devtools::install_github("andjar/ALASCA", ref = "main")

#install.packages("Rfast")
#library(Rfast)
#remotes::install_version("Rfast", version = "2.0.8")

library(ALASCA)
```

Run model with fold and treatment as main effects, samples as random effect to account for repeated measures. Will need to boostrap (default is 1000 times) to generate error estimates. 
```{r}
long_females<-long_females%>%
  rename(variable=gene)%>%
  select(!sex)

head(long_females)

res <- ALASCA(
  long_females,
  value ~ fold * treatment + (1|sample),
  n_validation_runs = 100, #bootstrap 100 times; takes about 10 min to run 
  validate = TRUE, #bootstrap
  reduce_dimensions = TRUE #reduce variables to highest explanatory value
)

```

View scree plot 

```{r}
pdf(file="output/77-asca-exon/scree_females.pdf", width=3, height=3)
plot(res, component = seq(1,10), effect = 1, type = 'scree')
dev.off()
```

Plot PC components for components with variance explained >0.5%. 

PC1: 38.65%
```{r}
plot(res, effect = 1, component = 1, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("gray", "darkred"),
     my_theme = theme_classic())
```

PC2: 24.51%
```{r}
plot(res, effect = 1, component = 2, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("gray", "darkred"),
     my_theme = theme_classic())
```

PC3: 16.62%
```{r}
plot(res, effect = 1, component = 3, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("gray", "darkred"),
     my_theme = theme_classic())
```

PC4: 11.99%
```{r}
plot(res, effect = 1, component = 4, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("gray", "darkred"),
     my_theme = theme_classic())
```

PC5: 6.49%
```{r}
plot(res, effect = 1, component = 5, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("gray", "darkred"),
     my_theme = theme_classic())
```

PC6: 1.2% (Couldn't estimate error for this PC so there isn't shading)
```{r}
plot(res, effect = 1, component = 6, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("gray", "darkred"),
     my_theme = theme_classic())
```

### Plot gene patterns 

PC1
```{r}
#individual plot
plot(res, component = 1, effect = 1, type = 'prediction', n_limit = 10, variable = c())
```

PC2
```{r}
#individual plot
plot(res, component = 2, effect = 1, type = 'prediction', n_limit = 10, variable = c())
```

PC3
```{r}
#individual plot
plot(res, component = 3, effect = 1, type = 'prediction', n_limit = 10, variable = c())
```

PC4
```{r}
#individual plot
plot(res, component = 4, effect = 1, type = 'prediction', n_limit = 10, variable = c())
```

PC5
```{r}
#individual plot
plot(res, component = 5, effect = 1, type = 'prediction', n_limit = 10, variable = c())
```

PC6
```{r}
#individual plot
plot(res, component = 6, effect = 1, type = 'prediction', n_limit = 10, variable = c())
```


output PC's to female plots folder 


## Extract lists of top 20 genes from each PC for genes that are different by treatment

The PCs that describe differences between treatment are PC5 and PC6. 

```{r}
loadings5<-get_loadings(res, component=5, effect=1, n_limit=10)
list5<-loadings5[[1]]$covars
loadings6<-get_loadings(res, component=6, effect=1, n_limit=10)
list6<-loadings6[[1]]$covars

list<-c(list5, list6)

capture.output(list, file="output/77-asca-exon/females_splicing_treatments_gene_list.csv")
```

## Generate panels for final figures  

